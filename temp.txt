

vault write sys/replication/dr/secondary/enable token="eyJhbGciOiJFUzUxMiIsInR5cCI6IkpXVCJ9.eyJhY2Nlc3NvciI6IiIsImFkZHIiOiJodHRwOi8vMy4yNy4yNC4zMjo4MjAwIiwiZXhwIjoxNjgwNTkwNTk4LCJpYXQiOjE2ODA1ODg3OTgsImp0aSI6Imh2cy5TQmhETFhZY2hHSkRoZ1dMbHhOejlaYk8iLCJuYmYiOjE2ODA1ODg3OTMsInR5cGUiOiJ3cmFwcGluZyJ9.AWwS2ElV6TZ0u3jYGPVjoAKay0IXoOn1w97xJgkeXdLTrh0hjGu1MK_uv7Nv_YSchh8-fh4BJR47CN9TlRkDLJXdAf5eJ3IzVdprdFxa8GTNZbCAwr3J3mYhoW1xWTPvHzNDyJaStAbGfjxRNmFgNUqobvIVjKKMSGvuWFuBWbGQKImg"



 vault operator generate-root -dr-token \
    -nonce=8e07c250-f233-6a71-6251-241a406c66cc \
    yy3B0VfG+g1lsBsMh3O98YB4r1bfRIEAKxtHQDlZ1AA=



vault operator generate-root -dr-token \
     -decode="DT0mXjlXMzB+OXFZFyBXChYiDG8ya1xkVns3Jw" \
     -otp="eKUpM9fIGK2oyQ8Lrnc8P2lWdMuV"





vault write sys/replication/dr/secondary/promote dr_operation_token=hvs.tnUy9rC6nqoFdLoWbY0326Bq





Apr 04 21:44:32 ip-10-0-101-22 vault[4636]: 2023-04-04T21:44:32.191Z [INFO]  libvault-pkcs11: C_Login: session=17049 userType=1 pin="****"
Apr 04 21:44:32 ip-10-0-101-22 vault[4636]: 2023-04-04T21:44:32.191Z [INFO]  libvault-pkcs11: Initiating new Vault connection to: addr=10.0.101.21:5696
Apr 04 21:44:32 ip-10-0-101-22 vault[4636]: 2023-04-04T21:44:32.192Z [WARN]  libvault-pkcs11: Error logging in: err="device error, code 401, err: error dialing KMIP server: dial tcp 10.0.101.21:5696: connect: connection refused"
Apr 04 21:44:32 ip-10-0-101-22 vault[4636]: 2023-04-04T21:44:32.193Z [ERROR] libvault-pkcs11: Error: err="device error, code 401, err: error dialing KMIP server: dial tcp 10.0.101.21:5696: connect: connection refused"
Apr 04 21:44:32 ip-10-0-101-22 vault[4636]: 2023-04-04T21:44:32.193Z [ERROR] libvault-pkcs11: Non-zero return value: ret=48
Apr 04 21:44:32 ip-10-0-101-22 vault[4636]: 2023-04-04T21:44:32.193Z [WARN]  seal.pkcs11: cannot open session, re-initializing PKCS#11 client library: try=3 of=3
Apr 04 21:44:32 ip-10-0-101-22 vault[4636]: 2023-04-04T21:44:32.193Z [INFO]  libvault-pkcs11: Closing session: sessionId=17049
Apr 04 21:44:32 ip-10-0-101-22 vault[4636]: 2023-04-04T21:44:32.193Z [INFO]  libvault-pkcs11: C_GetFunctionList
Apr 04 21:44:32 ip-10-0-101-22 vault[4636]: 2023-04-04T21:44:32.194Z [INFO]  libvault-pkcs11: C_Initialize: flags=2
Apr 04 21:44:33 ip-10-0-101-22 vault[4636]: 2023-04-04T21:44:33.194Z [WARN]  failed to unseal core: error="fetching stored unseal keys failed: failed to decrypt keys from storage: error generating key: error fetching session to test H


slot {
    server = "10.0.101.31:5696"
    tls_cert_path = "/etc/vault.d/cert.pem"
    ca_path = "/etc/vault.d/ca.pem"
    scope = "my-service"
}

Apr 04 21:46:35 ip-10-0-101-22 vault[4750]: 2023-04-04T21:46:35.631Z [INFO]  libvault-pkcs11: C_OpenSession
Apr 04 21:46:35 ip-10-0-101-22 vault[4750]: 2023-04-04T21:46:35.631Z [INFO]  libvault-pkcs11: C_Login: session=48874 userType=1 pin="****"
Apr 04 21:46:35 ip-10-0-101-22 vault[4750]: 2023-04-04T21:46:35.631Z [INFO]  libvault-pkcs11: Initiating new Vault connection to: addr=10.0.101.31:5696
Apr 04 21:46:35 ip-10-0-101-22 vault[4750]: 2023-04-04T21:46:35.634Z [WARN]  libvault-pkcs11: Error logging in: err="device error, code 401, err: error dialing KMIP server: tls: failed to verify certificate: x509: certificate is valid
Apr 04 21:46:35 ip-10-0-101-22 vault[4750]: 2023-04-04T21:46:35.634Z [ERROR] libvault-pkcs11: Error: err="device error, code 401, err: error dialing KMIP server: tls: failed to verify certificate: x509: certificate is valid for 10.0.1
Apr 04 21:46:35 ip-10-0-101-22 vault[4750]: 2023-04-04T21:46:35.634Z [ERROR] libvault-pkcs11: Non-zero return value: ret=48
Apr 04 21:46:35 ip-10-0-101-22 vault[4750]: 2023-04-04T21:46:35.634Z [WARN]  seal.pkcs11: cannot open session, re-initializing PKCS#11 client library: try=3 of=3
Apr 04 21:46:35 ip-10-0-101-22 vault[4750]: 2023-04-04T21:46:35.634Z [INFO]  libvault-pkcs11: Closing session: sessionId=48874
Apr 04 21:46:35 ip-10-0-101-22 vault[4750]: 2023-04-04T21:46:35.634Z [INFO]  libvault-pkcs11: C_GetFunctionList
Apr 04 21:46:35 ip-10-0-101-22 vault[4750]: 2023-04-04T21:46:35.634Z [INFO]  libvault-pkcs11: C_Initialize: flags=2


ubuntu@ip-10-0-101-22:/etc/vault.d$ sudo systemctl restart vault
ubuntu@ip-10-0-101-22:/etc/vault.d$ sudo systemctl status vault
● vault.service - Vault
   Loaded: loaded (/lib/systemd/system/vault.service; enabled; vendor preset: enabled)
   Active: active (running) since Tue 2023-04-04 21:50:32 UTC; 5s ago
  Process: 4822 ExecStartPre=/sbin/setcap cap_ipc_lock=+ep /usr/local/bin/vault (code=exited, status=0/SUCCESS)
 Main PID: 4824 (vault)
    Tasks: 13 (limit: 1134)
   CGroup: /system.slice/vault.service
           └─4824 /usr/local/bin/vault server -config /etc/vault.d

Apr 04 21:50:34 ip-10-0-101-22 vault[4824]: 2023-04-04T21:50:34.350Z [INFO]  libvault-pkcs11: C_EncryptInit: mechanism="0x00001085 CKM_AES_CBC_PAD"
Apr 04 21:50:34 ip-10-0-101-22 vault[4824]: 2023-04-04T21:50:34.350Z [INFO]  libvault-pkcs11: C_Encrypt
Apr 04 21:50:34 ip-10-0-101-22 vault[4824]: 2023-04-04T21:50:34.388Z [INFO]  replication.index: clean merkle tree complete: keys_cleaned=0
Apr 04 21:50:34 ip-10-0-101-22 vault[4824]: 2023-04-04T21:50:34.411Z [INFO]  libvault-pkcs11: C_Encrypt
Apr 04 21:50:34 ip-10-0-101-22 vault[4824]: 2023-04-04T21:50:34.473Z [INFO]  libvault-pkcs11: C_Logout
Apr 04 21:50:34 ip-10-0-101-22 vault[4824]: 2023-04-04T21:50:34.473Z [INFO]  libvault-pkcs11: C_CloseSession
Apr 04 21:50:34 ip-10-0-101-22 vault[4824]: 2023-04-04T21:50:34.473Z [INFO]  libvault-pkcs11: Closing session: sessionId=50509
Apr 04 21:50:34 ip-10-0-101-22 vault[4824]: 2023-04-04T21:50:34.473Z [INFO]  libvault-pkcs11: Closing KMIP client
Apr 04 21:50:34 ip-10-0-101-22 vault[4824]: 2023-04-04T21:50:34.478Z [INFO]  core: post-unseal setup complete
Apr 04 21:50:34 ip-10-0-101-22 vault[4824]: 2023-04-04T21:50:34.478Z [INFO]  core: performance standby: forwarding client is nil, waiting for new leader
ubuntu@ip-10-0-101-22:/etc/vault.d$ vault status
Key                      Value
---                      -----
Recovery Seal Type       shamir
Initialized              true
Sealed                   false
Total Recovery Shares    5
Threshold                3
Version                  1.13.1+ent.hsm
Build Date               2023-03-23T20:09:57Z
Storage Type             raft
Cluster Name             vault-cluster-06dc106f
Cluster ID               cbf80780-42e4-acd6-d5fd-d8b386862ec8
HA Enabled               true
HA Cluster               https://10.0.101.22:8201
HA Mode                  active
Active Since             2023-04-04T21:50:33.778859424Z
Raft Committed Index     30250
Raft Applied Index       30250
Last WAL                 54
~